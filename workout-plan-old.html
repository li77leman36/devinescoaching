<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Plan - Divines Coaching</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .plan-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .plan-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }
        
        .workout-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .add-workout-btn {
            background: linear-gradient(45deg, #00aa44, #44cc66);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }
        
        .add-workout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 170, 68, 0.3);
        }
        
        .workout-form {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border: 2px solid #e9ecef;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea {
            padding: 0.8rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .btn-save {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .workout-list {
            margin-top: 2rem;
        }
        
        .workout-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .workout-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }
        
        .workout-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .workout-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        
        .workout-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .detail-item {
            background: #f8f9fa;
            padding: 0.8rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .detail-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.3rem;
        }
        
        .detail-value {
            font-weight: 600;
            color: #333;
        }
        
        .workout-notes {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .workout-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        .btn-edit {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 2rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .empty-state h3 {
            margin-bottom: 1rem;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <button onclick="goBack()" class="back-btn">‚Üê Back to Dashboard</button>
        
        <div class="plan-header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h1 id="planTitle">Workout Plan</h1>
                <button onclick="showRenameForm()" class="btn-edit" style="padding: 0.8rem 1.5rem;">Rename Plan</button>
            </div>
            <div class="plan-info">
                <div class="info-card">
                    <h3>Client</h3>
                    <p id="clientName">Loading...</p>
                </div>
                <div class="info-card">
                    <h3>Date</h3>
                    <p id="planDate">Loading...</p>
                </div>
                <div class="info-card">
                    <h3>Status</h3>
                    <p id="planStatus">Loading...</p>
                </div>
                <div class="info-card">
                    <h3>Workouts</h3>
                    <p id="workoutCount">0</p>
                </div>
            </div>
            
            <!-- Rename Form -->
            <div id="renameForm" class="workout-form" style="display: none; margin-top: 1rem;">
                <h3>Rename Workout Plan</h3>
                <div class="form-group">
                    <label for="newPlanName">Plan Name:</label>
                    <input type="text" id="newPlanName" placeholder="Enter new plan name">
                </div>
                <div class="form-actions">
                    <button onclick="cancelRenameForm()" class="btn-cancel">Cancel</button>
                    <button onclick="savePlanName()" class="btn-save">Save Name</button>
                </div>
            </div>
        </div>
        
        <div class="workout-section">
            <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                <button onclick="showWorkoutForm()" class="add-workout-btn">+ Add Workout</button>
                <button onclick="debugAddWorkout()" class="btn-edit" style="padding: 1rem 1.5rem;">üîç Debug</button>
                <button onclick="alert('Test button works!')" class="btn-save" style="padding: 1rem 1.5rem;">üß™ Test</button>
                <button onclick="testFirebasePath()" class="btn-save" style="padding: 1rem 1.5rem; background: linear-gradient(45deg, #ff6b6b, #ff8e8e);">üî• Test Firebase</button>
                <button onclick="debugDatabaseLoading()" class="btn-save" style="padding: 1rem 1.5rem; background: linear-gradient(45deg, #9b59b6, #8e44ad);">üìä Debug DB</button>
            </div>
            
            <div id="workoutForm" class="workout-form" style="display: none;">
                <h3>Add New Workout</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workoutName">Workout Name</label>
                        <input type="text" id="workoutName" placeholder="e.g., Push-ups, Squats, Bench Press">
                    </div>
                    <div class="form-group">
                        <label for="workoutSets">Sets</label>
                        <input type="number" id="workoutSets" placeholder="3" min="1" max="20">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workoutReps">Reps</label>
                        <input type="text" id="workoutReps" placeholder="e.g., 10-15, 8, 12-20">
                    </div>
                    <div class="form-group">
                        <label for="workoutDuration">Duration (optional)</label>
                        <input type="text" id="workoutDuration" placeholder="e.g., 30 seconds, 1 minute">
                    </div>
                </div>
                <div class="form-group">
                    <label for="workoutNotes">Notes</label>
                    <textarea id="workoutNotes" placeholder="Add any specific instructions, form tips, or modifications..."></textarea>
                </div>
                <div class="form-actions">
                    <button onclick="cancelWorkoutForm()" class="btn-cancel">Cancel</button>
                    <button onclick="saveWorkout()" class="btn-save">Save Workout</button>
                </div>
            </div>
            
            <div id="workoutList" class="workout-list">
                <!-- Workouts will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDocs, getDoc, query, where, orderBy, updateDoc, deleteDoc, setDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAqmII6xw9zVXmBYK4sYQXM0d8LSC8tJ9A",
            authDomain: "ptapp-f4b4d.firebaseapp.com",
            projectId: "ptapp-f4b4d",
            storageBucket: "ptapp-f4b4d.firebasestorage.app",
            messagingSenderId: "360387400618",
            appId: "1:360387400618:web:5e23bf828abfb4d76911d3",
            measurementId: "G-6RBWTHBYX1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Make Firebase variables and functions globally available
        window.db = db;
        window.auth = auth;
        window.firebaseApp = app;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.setDoc = setDoc;
        window.collection = collection;
        window.doc = doc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.limit = limit;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.sendPasswordResetEmail = sendPasswordResetEmail;

        // Global variables
        let currentPlan = null;
        let currentClient = null;

        // Make all functions globally available immediately
        window.showWorkoutForm = function() {
            console.log('üîç showWorkoutForm called');
            console.log('workoutForm element:', document.getElementById('workoutForm'));
            
            const form = document.getElementById('workoutForm');
            if (form) {
                form.style.display = 'block';
                document.getElementById('workoutName').focus();
                console.log('‚úÖ Workout form shown');
            } else {
                console.error('‚ùå Workout form element not found');
                alert('‚ùå Workout form element not found!');
            }
        };

        window.debugAddWorkout = function() {
            console.log('üîç DEBUG ADD WORKOUT:');
            console.log('showWorkoutForm function:', typeof window.showWorkoutForm);
            console.log('workoutForm element:', document.getElementById('workoutForm'));
            console.log('add-workout-btn element:', document.querySelector('.add-workout-btn'));
            
            // Try to call the function directly
            try {
                window.showWorkoutForm();
            } catch (error) {
                console.error('‚ùå Error calling showWorkoutForm:', error);
            }
        };

        window.testFirebasePath = async function() {
            try {
                console.log('üî• TESTING FIREBASE PATH:');
                console.log('Current Client:', currentClient);
                console.log('Current Plan:', currentPlan);
                
                if (!currentClient || !currentPlan) {
                    alert('‚ùå No client or plan loaded!');
                    return;
                }
                
                const docPath = `clients/${currentClient.id}/plans/${currentPlan.id}`;
                console.log('üìÅ Document Path:', docPath);
                
                // Try to read the document
                const docRef = window.doc(window.db, 'clients', currentClient.id, 'plans', currentPlan.id);
                const docSnap = await window.getDoc(docRef);
                
                if (docSnap.exists()) {
                    console.log('‚úÖ Document exists!');
                    console.log('üìÑ Document data:', docSnap.data());
                    alert(`‚úÖ Firebase path is correct!\n\nPath: ${docPath}\n\nDocument exists and contains ${docSnap.data().exercises?.length || 0} exercises.`);
                } else {
                    console.log('‚ùå Document does not exist!');
                    alert(`‚ùå Document not found!\n\nPath: ${docPath}\n\nThis might be why workouts aren't saving.`);
                }
                
            } catch (error) {
                console.error('‚ùå Firebase test failed:', error);
                alert(`‚ùå Firebase test failed: ${error.message}`);
            }
        };

        window.saveWorkout = async function() {
            const name = document.getElementById('workoutName').value.trim();
            const sets = document.getElementById('workoutSets').value;
            const reps = document.getElementById('workoutReps').value.trim();
            const duration = document.getElementById('workoutDuration').value.trim();
            const notes = document.getElementById('workoutNotes').value.trim();
            
            if (!name) {
                alert('‚ùå Please enter a workout name');
                return;
            }
            
            try {
                const workout = {
                    id: Date.now(),
                    name: name,
                    sets: sets ? parseInt(sets) : null,
                    reps: reps || null,
                    duration: duration || null,
                    description: notes || null,
                    status: 'assigned',
                    assignedDate: new Date().toISOString()
                };
                
                // Add workout to current plan
                if (!currentPlan.exercises) {
                    currentPlan.exercises = [];
                }
                currentPlan.exercises.push(workout);
                
                // Save to Firebase
                const docPath = `clients/${currentClient.id}/plans/${currentPlan.id}`;
                console.log('üíæ Saving workout to Firebase path:', docPath);
                console.log('üíæ Client ID:', currentClient.id);
                console.log('üíæ Plan ID:', currentPlan.id);
                console.log('üíæ Exercises array:', currentPlan.exercises);
                
                await window.updateDoc(window.doc(window.db, 'clients', currentClient.id, 'plans', currentPlan.id), {
                    exercises: currentPlan.exercises
                });
                
                // Update UI
                document.getElementById('workoutCount').textContent = currentPlan.exercises.length;
                loadWorkouts();
                cancelWorkoutForm();
                
                console.log('‚úÖ Workout saved:', workout);
                
            } catch (error) {
                console.error('‚ùå Error saving workout:', error);
                alert('Failed to save workout');
            }
        };

        window.cancelWorkoutForm = function() {
            document.getElementById('workoutForm').style.display = 'none';
            clearWorkoutForm();
        };

        window.goBack = function() {
            window.location.href = 'pt-dashboard.html';
        };

        window.editWorkout = function(index) {
            const workout = currentPlan.exercises[index];
            
            // Populate form with existing data
            document.getElementById('workoutName').value = workout.name || '';
            document.getElementById('workoutSets').value = workout.sets || '';
            document.getElementById('workoutReps').value = workout.reps || '';
            document.getElementById('workoutDuration').value = workout.duration || '';
            document.getElementById('workoutNotes').value = workout.description || '';
            
            // Show form
            document.getElementById('workoutForm').style.display = 'block';
            
            // Change save button to update
            const saveBtn = document.querySelector('.btn-save');
            saveBtn.textContent = 'Update Workout';
            saveBtn.onclick = () => updateWorkout(index);
        };

        window.deleteWorkout = async function(index) {
            if (!confirm('Are you sure you want to delete this workout?')) {
                return;
            }
            
            try {
                // Remove workout from array
                currentPlan.exercises.splice(index, 1);
                
                // Save to Firebase
                const docPath = `clients/${currentClient.id}/plans/${currentPlan.id}`;
                console.log('üíæ Deleting workout from Firebase path:', docPath);
                console.log('üíæ Remaining exercises array:', currentPlan.exercises);
                
                await window.updateDoc(window.doc(window.db, 'clients', currentClient.id, 'plans', currentPlan.id), {
                    exercises: currentPlan.exercises
                });
                
                // Update UI
                document.getElementById('workoutCount').textContent = currentPlan.exercises.length;
                loadWorkouts();
                
                console.log('‚úÖ Workout deleted');
                
            } catch (error) {
                console.error('‚ùå Error deleting workout:', error);
                alert('Failed to delete workout');
            }
        };

        window.updateWorkout = async function(index) {
            const name = document.getElementById('workoutName').value.trim();
            const sets = document.getElementById('workoutSets').value;
            const reps = document.getElementById('workoutReps').value.trim();
            const duration = document.getElementById('workoutDuration').value.trim();
            const notes = document.getElementById('workoutNotes').value.trim();
            
            if (!name) {
                alert('‚ùå Please enter a workout name');
                return;
            }
            
            try {
                // Update workout
                currentPlan.exercises[index] = {
                    ...currentPlan.exercises[index],
                    name: name,
                    sets: sets ? parseInt(sets) : null,
                    reps: reps || null,
                    duration: duration || null,
                    description: notes || null
                };
                
                // Save to Firebase
                const docPath = `clients/${currentClient.id}/plans/${currentPlan.id}`;
                console.log('üíæ Updating workout in Firebase path:', docPath);
                console.log('üíæ Updated exercises array:', currentPlan.exercises);
                
                await window.updateDoc(window.doc(window.db, 'clients', currentClient.id, 'plans', currentPlan.id), {
                    exercises: currentPlan.exercises
                });
                
                // Update UI
                loadWorkouts();
                cancelWorkoutForm();
                
                // Reset save button
                const saveBtn = document.querySelector('.btn-save');
                saveBtn.textContent = 'Save Workout';
                saveBtn.onclick = saveWorkout;
                
                console.log('‚úÖ Workout updated');
                
            } catch (error) {
                console.error('‚ùå Error updating workout:', error);
                alert('Failed to update workout');
            }
        };

        // Rename functionality
        window.showRenameForm = function() {
            document.getElementById('renameForm').style.display = 'block';
            document.getElementById('newPlanName').value = currentPlan.name || '';
            document.getElementById('newPlanName').focus();
        };

        window.cancelRenameForm = function() {
            document.getElementById('renameForm').style.display = 'none';
            document.getElementById('newPlanName').value = '';
        };

        window.savePlanName = async function() {
            const newName = document.getElementById('newPlanName').value.trim();
            
            if (!newName) {
                alert('‚ùå Please enter a plan name');
                return;
            }
            
            try {
                // Update plan name in Firebase
                await window.updateDoc(window.doc(window.db, 'clients', currentClient.id, 'plans', currentPlan.id), {
                    name: newName
                });
                
                // Update local data
                currentPlan.name = newName;
                
                // Update UI
                document.getElementById('planTitle').textContent = newName;
                window.cancelRenameForm();
                
                console.log('‚úÖ Plan name updated:', newName);
                
            } catch (error) {
                console.error('‚ùå Error updating plan name:', error);
                alert('Failed to update plan name');
            }
        };

        window.debugDatabaseLoading = async function() {
            try {
                console.log('üìä DEBUGGING DATABASE LOADING:');
                
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const clientId = urlParams.get('clientId');
                const planId = urlParams.get('planId');
                
                console.log('üìä URL Parameters:', { clientId, planId });
                
                if (!clientId || !planId) {
                    alert('‚ùå Missing clientId or planId in URL');
                    return;
                }
                
                // Test Firebase connection
                console.log('üìä Testing Firebase connection...');
                console.log('üìä Firebase DB:', window.db);
                console.log('üìä Firebase functions available:', {
                    getDoc: typeof window.getDoc,
                    getDocs: typeof window.getDocs,
                    doc: typeof window.doc,
                    collection: typeof window.collection
                });
                
                // Test client document
                console.log('üìä Testing client document...');
                const clientDocRef = window.doc(window.db, 'clients', clientId);
                console.log('üìä Client document path:', clientDocRef.path);
                const clientDoc = await window.getDoc(clientDocRef);
                console.log('üìä Client document exists:', clientDoc.exists());
                
                if (clientDoc.exists()) {
                    console.log('üìä Client data:', clientDoc.data());
                } else {
                    console.log('‚ùå Client document not found!');
                }
                
                // Test plans subcollection
                console.log('üìä Testing plans subcollection...');
                const plansQuery = window.query(window.collection(window.db, 'clients', clientId, 'plans'));
                const plansSnapshot = await window.getDocs(plansQuery);
                console.log('üìä Plans subcollection exists:', !plansSnapshot.empty);
                console.log('üìä Number of plans:', plansSnapshot.size);
                
                if (!plansSnapshot.empty) {
                    console.log('üìä Available plans:');
                    plansSnapshot.forEach(doc => {
                        console.log(`üìä Plan ID: ${doc.id}`, doc.data());
                    });
                }
                
                // Test specific plan
                console.log('üìä Testing specific plan...');
                const planDocRef = window.doc(window.db, 'clients', clientId, 'plans', planId);
                console.log('üìä Plan document path:', planDocRef.path);
                const planDoc = await window.getDoc(planDocRef);
                console.log('üìä Plan document exists:', planDoc.exists());
                
                if (planDoc.exists()) {
                    console.log('üìä Plan data:', planDoc.data());
                } else {
                    console.log('‚ùå Plan document not found!');
                }
                
                // Summary
                const summary = `
üìä DATABASE DEBUG SUMMARY:
‚Ä¢ Client ID: ${clientId}
‚Ä¢ Plan ID: ${planId}
‚Ä¢ Client exists: ${clientDoc.exists()}
‚Ä¢ Plans subcollection exists: ${!plansSnapshot.empty}
‚Ä¢ Number of plans: ${plansSnapshot.size}
‚Ä¢ Specific plan exists: ${planDoc.exists()}
‚Ä¢ Current client loaded: ${!!currentClient}
‚Ä¢ Current plan loaded: ${!!currentPlan}
                `;
                
                console.log(summary);
                alert(summary);
                
            } catch (error) {
                console.error('‚ùå Database debug failed:', error);
                alert(`‚ùå Database debug failed: ${error.message}`);
            }
        };

        // Helper functions
        function clearWorkoutForm() {
            document.getElementById('workoutName').value = '';
            document.getElementById('workoutSets').value = '';
            document.getElementById('workoutReps').value = '';
            document.getElementById('workoutDuration').value = '';
            document.getElementById('workoutNotes').value = '';
        }

        function loadWorkouts() {
            const workoutList = document.getElementById('workoutList');
            
            if (!currentPlan.exercises || currentPlan.exercises.length === 0) {
                workoutList.innerHTML = `
                    <div class="empty-state">
                        <h3>No workouts added yet</h3>
                        <p>Click "Add Workout" to start building this plan</p>
                    </div>
                `;
                return;
            }
            
            workoutList.innerHTML = currentPlan.exercises.map((workout, index) => `
                <div class="workout-item">
                    <div class="workout-header">
                        <div class="workout-name">${workout.name}</div>
                    </div>
                    <div class="workout-details">
                        <div class="detail-item">
                            <div class="detail-label">Sets</div>
                            <div class="detail-value">${workout.sets || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Reps</div>
                            <div class="detail-value">${workout.reps || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Duration</div>
                            <div class="detail-value">${workout.duration || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">${workout.status || 'assigned'}</div>
                        </div>
                    </div>
                    ${workout.description ? `
                        <div class="workout-notes">
                            <strong>Notes:</strong> ${workout.description}
                        </div>
                    ` : ''}
                    <div class="workout-actions">
                        <button onclick="editWorkout(${index})" class="btn-edit">Edit</button>
                        <button onclick="deleteWorkout(${index})" class="btn-delete">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Initialize page
        window.addEventListener('load', () => {
            console.log('üèãÔ∏è Workout Plan page loaded');
            console.log('üîç DOM elements check:');
            console.log('- Add workout button:', document.querySelector('.add-workout-btn'));
            console.log('- Workout form:', document.getElementById('workoutForm'));
            console.log('- showWorkoutForm function:', typeof showWorkoutForm);
            
            // Make ALL functions globally available
            window.showWorkoutForm = showWorkoutForm;
            window.debugAddWorkout = debugAddWorkout;
            window.showRenameForm = showRenameForm;
            window.cancelRenameForm = cancelRenameForm;
            window.savePlanName = savePlanName;
            window.testFirebasePath = testFirebasePath;
            window.debugDatabaseLoading = debugDatabaseLoading;
            window.saveWorkout = saveWorkout;
            window.cancelWorkoutForm = cancelWorkoutForm;
            window.editWorkout = editWorkout;
            window.deleteWorkout = deleteWorkout;
            window.updateWorkout = updateWorkout;
            window.goBack = goBack;
            
            console.log('‚úÖ All functions made globally available');
            
            loadPlanFromURL();
        });

        function loadPlanFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const clientId = urlParams.get('clientId');
            const planId = urlParams.get('planId');
            
            if (!clientId || !planId) {
                alert('‚ùå Missing client or plan information');
                goBack();
                return;
            }
            
            console.log('üìã Loading plan:', { clientId, planId });
            loadPlan(clientId, planId);
        }

        async function loadPlan(clientId, planId) {
            try {
                console.log('üìã Loading plan details...');
                console.log('üìã Client ID:', clientId);
                console.log('üìã Plan ID:', planId);
                
                // Load client information
                console.log('üìã Loading client document...');
                const clientDoc = await window.getDoc(window.doc(window.db, 'clients', clientId));
                console.log('üìã Client document exists:', clientDoc.exists());
                if (clientDoc.exists()) {
                    currentClient = { id: clientId, ...clientDoc.data() };
                    console.log('üìã Client data loaded:', currentClient);
                    document.getElementById('clientName').textContent = currentClient.name || 'Unknown Client';
                } else {
                    console.error('‚ùå Client document not found!');
                    alert('‚ùå Client not found in database');
                    goBack();
                    return;
                }
                
                // Load plan information
                console.log('üìã Loading plan document...');
                const planDocRef = window.doc(window.db, 'clients', clientId, 'plans', planId);
                console.log('üìã Plan document path:', planDocRef.path);
                const planDoc = await window.getDoc(planDocRef);
                console.log('üìã Plan document exists:', planDoc.exists());
                
                if (planDoc.exists()) {
                    currentPlan = { id: planId, ...planDoc.data() };
                    console.log('üìã Plan data loaded:', currentPlan);
                    console.log('üìã Plan exercises:', currentPlan.exercises);
                    
                    // Update UI
                    document.getElementById('planTitle').textContent = currentPlan.name || `Workout Plan - ${currentPlan.date}`;
                    document.getElementById('planDate').textContent = `${currentPlan.date} at ${currentPlan.time}`;
                    document.getElementById('planStatus').textContent = currentPlan.status || 'assigned';
                    document.getElementById('workoutCount').textContent = currentPlan.exercises ? currentPlan.exercises.length : 0;
                    
                    // Load workouts
                    loadWorkouts();
                } else {
                    console.error('‚ùå Plan document not found!');
                    console.log('üìã Checking if plans subcollection exists...');
                    
                    // Check if the plans subcollection exists
                    const plansQuery = window.query(window.collection(window.db, 'clients', clientId, 'plans'));
                    const plansSnapshot = await window.getDocs(plansQuery);
                    console.log('üìã Plans subcollection exists:', !plansSnapshot.empty);
                    console.log('üìã Number of plans found:', plansSnapshot.size);
                    
                    if (plansSnapshot.empty) {
                        alert('‚ùå No plans found for this client. The plans subcollection is empty.');
                    } else {
                        console.log('üìã Available plans:');
                        plansSnapshot.forEach(doc => {
                            console.log('üìã Plan ID:', doc.id, 'Data:', doc.data());
                        });
                        alert(`‚ùå Plan ${planId} not found, but ${plansSnapshot.size} other plans exist for this client.`);
                    }
                    goBack();
                }
                
            } catch (error) {
                console.error('‚ùå Error loading plan:', error);
                console.error('‚ùå Error details:', error.message);
                console.error('‚ùå Error code:', error.code);
                alert(`Failed to load plan details: ${error.message}`);
            }
        }

        function showWorkoutForm() {
            console.log('üîç showWorkoutForm called');
            console.log('workoutForm element:', document.getElementById('workoutForm'));
            
            const form = document.getElementById('workoutForm');
            if (form) {
                form.style.display = 'block';
                document.getElementById('workoutName').focus();
                console.log('‚úÖ Workout form shown');
            } else {
                console.error('‚ùå Workout form element not found');
                alert('‚ùå Workout form element not found!');
            }
        }

        async function saveWorkout() {
            const name = document.getElementById('workoutName').value.trim();
            const sets = document.getElementById('workoutSets').value;
            const reps = document.getElementById('workoutReps').value.trim();
            const duration = document.getElementById('workoutDuration').value.trim();
            const notes = document.getElementById('workoutNotes').value.trim();
            
            if (!name) {
                alert('‚ùå Please enter a workout name');
                return;
            }
            
            try {
                const workout = {
                    id: Date.now(),
                    name: name,
                    sets: sets ? parseInt(sets) : null,
                    reps: reps || null,
                    duration: duration || null,
                    description: notes || null,
                    status: 'assigned',
                    assignedDate: new Date().toISOString()
                };
                
                // Add workout to current plan
                if (!currentPlan.exercises) {
                    currentPlan.exercises = [];
                }
                currentPlan.exercises.push(workout);
                
                // Save to Firebase
                const docPath = `clients/${currentClient.id}/plans/${currentPlan.id}`;
                console.log('üíæ Saving workout to Firebase path:', docPath);
                console.log('üíæ Client ID:', currentClient.id);
                console.log('üíæ Plan ID:', currentPlan.id);
                console.log('üíæ Exercises array:', currentPlan.exercises);
                
                await window.updateDoc(window.doc(window.db, 'clients', currentClient.id, 'plans', currentPlan.id), {
                    exercises: currentPlan.exercises
                });
                
                // Update UI
                document.getElementById('workoutCount').textContent = currentPlan.exercises.length;
                loadWorkouts();
                cancelWorkoutForm();
                
                console.log('‚úÖ Workout saved:', workout);
                
            } catch (error) {
                console.error('‚ùå Error saving workout:', error);
                alert('Failed to save workout');
            }
        }

        async function editWorkout(index) {
            const workout = currentPlan.exercises[index];
            
            // Populate form with existing data
            document.getElementById('workoutName').value = workout.name || '';
            document.getElementById('workoutSets').value = workout.sets || '';
            document.getElementById('workoutReps').value = workout.reps || '';
            document.getElementById('workoutDuration').value = workout.duration || '';
            document.getElementById('workoutNotes').value = workout.description || '';
            
            // Show form
            document.getElementById('workoutForm').style.display = 'block';
            
            // Change save button to update
            const saveBtn = document.querySelector('.btn-save');
            saveBtn.textContent = 'Update Workout';
            saveBtn.onclick = () => updateWorkout(index);
        }

        async function updateWorkout(index) {
            const name = document.getElementById('workoutName').value.trim();
            const sets = document.getElementById('workoutSets').value;
            const reps = document.getElementById('workoutReps').value.trim();
            const duration = document.getElementById('workoutDuration').value.trim();
            const notes = document.getElementById('workoutNotes').value.trim();
            
            if (!name) {
                alert('‚ùå Please enter a workout name');
                return;
            }
            
            try {
                // Update workout
                currentPlan.exercises[index] = {
                    ...currentPlan.exercises[index],
                    name: name,
                    sets: sets ? parseInt(sets) : null,
                    reps: reps || null,
                    duration: duration || null,
                    description: notes || null
                };
                
                // Save to Firebase
                const docPath = `clients/${currentClient.id}/plans/${currentPlan.id}`;
                console.log('üíæ Updating workout in Firebase path:', docPath);
                console.log('üíæ Updated exercises array:', currentPlan.exercises);
                
                await window.updateDoc(window.doc(window.db, 'clients', currentClient.id, 'plans', currentPlan.id), {
                    exercises: currentPlan.exercises
                });
                
                // Update UI
                loadWorkouts();
                cancelWorkoutForm();
                
                // Reset save button
                const saveBtn = document.querySelector('.btn-save');
                saveBtn.textContent = 'Save Workout';
                saveBtn.onclick = saveWorkout;
                
                console.log('‚úÖ Workout updated');
                
            } catch (error) {
                console.error('‚ùå Error updating workout:', error);
                alert('Failed to update workout');
            }
        }

        async function deleteWorkout(index) {
            if (!confirm('Are you sure you want to delete this workout?')) {
                return;
            }
            
            try {
                // Remove workout from array
                currentPlan.exercises.splice(index, 1);
                
                // Save to Firebase
                const docPath = `clients/${currentClient.id}/plans/${currentPlan.id}`;
                console.log('üíæ Deleting workout from Firebase path:', docPath);
                console.log('üíæ Remaining exercises array:', currentPlan.exercises);
                
                await window.updateDoc(window.doc(window.db, 'clients', currentClient.id, 'plans', currentPlan.id), {
                    exercises: currentPlan.exercises
                });
                
                // Update UI
                document.getElementById('workoutCount').textContent = currentPlan.exercises.length;
                loadWorkouts();
                
                console.log('‚úÖ Workout deleted');
                
            } catch (error) {
                console.error('‚ùå Error deleting workout:', error);
                alert('Failed to delete workout');
            }
        }

        function goBack() {
            window.location.href = 'pt-dashboard.html';
        }

        // Rename functionality
        function showRenameForm() {
            document.getElementById('renameForm').style.display = 'block';
            document.getElementById('newPlanName').value = currentPlan.name || '';
            document.getElementById('newPlanName').focus();
        }

        function cancelRenameForm() {
            document.getElementById('renameForm').style.display = 'none';
            document.getElementById('newPlanName').value = '';
        }

        async function savePlanName() {
            const newName = document.getElementById('newPlanName').value.trim();
            
            if (!newName) {
                alert('‚ùå Please enter a plan name');
                return;
            }
            
            try {
                // Update plan name in Firebase
                await window.updateDoc(window.doc(window.db, 'clients', currentClient.id, 'plans', currentPlan.id), {
                    name: newName
                });
                
                // Update local data
                currentPlan.name = newName;
                
                // Update UI
                document.getElementById('planTitle').textContent = newName;
                cancelRenameForm();
                
                console.log('‚úÖ Plan name updated:', newName);
                
            } catch (error) {
                console.error('‚ùå Error updating plan name:', error);
                alert('Failed to update plan name');
            }
        }

        // Test Firebase path and connection
        async function testFirebasePath() {
            try {
                console.log('üî• TESTING FIREBASE PATH:');
                console.log('Current Client:', currentClient);
                console.log('Current Plan:', currentPlan);
                
                if (!currentClient || !currentPlan) {
                    alert('‚ùå No client or plan loaded!');
                    return;
                }
                
                const docPath = `clients/${currentClient.id}/plans/${currentPlan.id}`;
                console.log('üìÅ Document Path:', docPath);
                
                // Try to read the document
                const docRef = window.doc(window.db, 'clients', currentClient.id, 'plans', currentPlan.id);
                const docSnap = await window.getDoc(docRef);
                
                if (docSnap.exists()) {
                    console.log('‚úÖ Document exists!');
                    console.log('üìÑ Document data:', docSnap.data());
                    alert(`‚úÖ Firebase path is correct!\n\nPath: ${docPath}\n\nDocument exists and contains ${docSnap.data().exercises?.length || 0} exercises.`);
                } else {
                    console.log('‚ùå Document does not exist!');
                    alert(`‚ùå Document not found!\n\nPath: ${docPath}\n\nThis might be why workouts aren't saving.`);
                }
                
            } catch (error) {
                console.error('‚ùå Firebase test failed:', error);
                alert(`‚ùå Firebase test failed: ${error.message}`);
            }
        }
    </script>
</body>
</html>
