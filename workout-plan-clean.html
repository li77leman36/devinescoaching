<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Plan - Divines Coaching</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <button onclick="goBack()" class="back-btn">‚Üê Back to PT Dashboard</button>
            <h1>Workout Plan</h1>
            <div class="debug-buttons">
                <button onclick="debugAddWorkout()" class="debug-btn">üß™ Test</button>
                <button onclick="testFirebasePath()" class="debug-btn">üî• Test Firebase</button>
                <button onclick="debugDatabaseLoading()" class="debug-btn">üìä Debug DB</button>
            </div>
        </header>

        <div class="plan-header">
            <div class="plan-info">
                <h2 id="planTitle">Loading...</h2>
                <div class="plan-meta">
                    <span id="clientInfo">Client: Loading...</span>
                    <span id="planDate">Date: Loading...</span>
                    <span id="planStatus">Status: Loading...</span>
                    <span id="workoutCount">Workouts: 0</span>
                </div>
            </div>
            <div class="plan-actions">
                <button onclick="showRenameForm()" class="btn-rename">Rename Plan</button>
                <button onclick="showWorkoutForm()" class="add-workout-btn">Add Workout</button>
            </div>
        </div>

        <!-- Rename Form -->
        <div id="renameForm" class="workout-form" style="display: none;">
            <div class="form-header">
                <h3>Rename Plan</h3>
            </div>
            <div class="form-body">
                <div class="form-group">
                    <label for="newPlanName">Plan Name:</label>
                    <input type="text" id="newPlanName" placeholder="Enter new plan name">
                </div>
            </div>
            <div class="form-actions">
                <button onclick="savePlanName()" class="btn-save">Save Name</button>
                <button onclick="cancelRenameForm()" class="btn-cancel">Cancel</button>
            </div>
        </div>

        <!-- Workout Form -->
        <div id="workoutForm" class="workout-form" style="display: none;">
            <div class="form-header">
                <h3>Add New Workout</h3>
            </div>
            <div class="form-body">
                <div class="form-group">
                    <label for="workoutName">Exercise Name:</label>
                    <input type="text" id="workoutName" placeholder="e.g., Bench Press" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workoutSets">Sets:</label>
                        <input type="number" id="workoutSets" placeholder="3" min="1">
                    </div>
                    <div class="form-group">
                        <label for="workoutReps">Reps:</label>
                        <input type="text" id="workoutReps" placeholder="10-12">
                    </div>
                    <div class="form-group">
                        <label for="workoutDuration">Duration:</label>
                        <input type="text" id="workoutDuration" placeholder="30 minutes">
                    </div>
                </div>
                <div class="form-group">
                    <label for="workoutNotes">Notes:</label>
                    <textarea id="workoutNotes" placeholder="Additional instructions or notes"></textarea>
                </div>
            </div>
            <div class="form-actions">
                <button onclick="saveWorkout()" class="btn-save">Save Workout</button>
                <button onclick="cancelWorkoutForm()" class="btn-cancel">Cancel</button>
            </div>
        </div>

        <!-- Workouts List -->
        <div class="workouts-section">
            <h3>Workouts</h3>
            <div id="workoutList" class="workouts-list">
                <div class="empty-state">
                    <h3>No workouts added yet</h3>
                    <p>Click "Add Workout" to start building this plan</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC7xCPBN-mEcfHr8B7sZP5S-eZxJq2KQ8Y",
            authDomain: "divines-coaching.firebaseapp.com",
            projectId: "divines-coaching",
            storageBucket: "divines-coaching.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456789"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Make Firebase globally available
        window.firebase = firebase;
        window.db = db;
        window.auth = auth;

        // Current plan and client data
        let currentClient = null;
        let currentPlan = null;

        // Define all functions globally
        window.showWorkoutForm = function() {
            console.log('üîç showWorkoutForm called');
            const form = document.getElementById('workoutForm');
            if (form) {
                form.style.display = 'block';
                console.log('‚úÖ Workout form shown');
            } else {
                console.error('‚ùå Workout form element not found');
                alert('‚ùå Workout form element not found!');
            }
        };

        window.cancelWorkoutForm = function() {
            document.getElementById('workoutForm').style.display = 'none';
            clearWorkoutForm();
        };

        window.clearWorkoutForm = function() {
            document.getElementById('workoutName').value = '';
            document.getElementById('workoutSets').value = '';
            document.getElementById('workoutReps').value = '';
            document.getElementById('workoutDuration').value = '';
            document.getElementById('workoutNotes').value = '';
        };

        window.saveWorkout = async function() {
            const name = document.getElementById('workoutName').value.trim();
            const sets = document.getElementById('workoutSets').value;
            const reps = document.getElementById('workoutReps').value.trim();
            const duration = document.getElementById('workoutDuration').value.trim();
            const notes = document.getElementById('workoutNotes').value.trim();
            
            if (!name) {
                alert('‚ùå Please enter a workout name');
                return;
            }
            
            try {
                const workout = {
                    id: Date.now(),
                    name: name,
                    sets: sets ? parseInt(sets) : null,
                    reps: reps || null,
                    duration: duration || null,
                    description: notes || null,
                    status: 'assigned',
                    assignedDate: new Date().toISOString()
                };
                
                // Add workout to current plan
                if (!currentPlan.exercises) {
                    currentPlan.exercises = [];
                }
                currentPlan.exercises.push(workout);
                
                // Save to Firebase
                const docPath = `clients/${currentClient.id}/plans/${currentPlan.id}`;
                console.log('üíæ Saving workout to Firebase path:', docPath);
                console.log('üíæ Client ID:', currentClient.id);
                console.log('üíæ Plan ID:', currentPlan.id);
                console.log('üíæ Exercises array:', currentPlan.exercises);
                
                await db.collection('clients').doc(currentClient.id).collection('plans').doc(currentPlan.id).update({
                    exercises: currentPlan.exercises
                });
                
                // Update UI
                document.getElementById('workoutCount').textContent = currentPlan.exercises.length;
                loadWorkouts();
                window.cancelWorkoutForm();
                
                console.log('‚úÖ Workout saved:', workout);
                
            } catch (error) {
                console.error('‚ùå Error saving workout:', error);
                alert('Failed to save workout');
            }
        };

        window.editWorkout = async function(index) {
            const workout = currentPlan.exercises[index];
            
            // Populate form with existing data
            document.getElementById('workoutName').value = workout.name || '';
            document.getElementById('workoutSets').value = workout.sets || '';
            document.getElementById('workoutReps').value = workout.reps || '';
            document.getElementById('workoutDuration').value = workout.duration || '';
            document.getElementById('workoutNotes').value = workout.description || '';
            
            // Show form
            document.getElementById('workoutForm').style.display = 'block';
            
            // Change save button to update
            const saveBtn = document.querySelector('.btn-save');
            saveBtn.textContent = 'Update Workout';
            saveBtn.onclick = () => window.updateWorkout(index);
        };

        window.updateWorkout = async function(index) {
            const name = document.getElementById('workoutName').value.trim();
            const sets = document.getElementById('workoutSets').value;
            const reps = document.getElementById('workoutReps').value.trim();
            const duration = document.getElementById('workoutDuration').value.trim();
            const notes = document.getElementById('workoutNotes').value.trim();
            
            if (!name) {
                alert('‚ùå Please enter a workout name');
                return;
            }
            
            try {
                // Update workout
                currentPlan.exercises[index] = {
                    ...currentPlan.exercises[index],
                    name: name,
                    sets: sets ? parseInt(sets) : null,
                    reps: reps || null,
                    duration: duration || null,
                    description: notes || null
                };
                
                // Save to Firebase
                const docPath = `clients/${currentClient.id}/plans/${currentPlan.id}`;
                console.log('üíæ Updating workout in Firebase path:', docPath);
                console.log('üíæ Updated exercises array:', currentPlan.exercises);
                
                await db.collection('clients').doc(currentClient.id).collection('plans').doc(currentPlan.id).update({
                    exercises: currentPlan.exercises
                });
                
                // Update UI
                loadWorkouts();
                window.cancelWorkoutForm();
                
                // Reset save button
                const saveBtn = document.querySelector('.btn-save');
                saveBtn.textContent = 'Save Workout';
                saveBtn.onclick = window.saveWorkout;
                
                console.log('‚úÖ Workout updated');
                
            } catch (error) {
                console.error('‚ùå Error updating workout:', error);
                alert('Failed to update workout');
            }
        };

        window.deleteWorkout = async function(index) {
            if (!confirm('Are you sure you want to delete this workout?')) {
                return;
            }
            
            try {
                // Remove workout from array
                currentPlan.exercises.splice(index, 1);
                
                // Save to Firebase
                const docPath = `clients/${currentClient.id}/plans/${currentPlan.id}`;
                console.log('üíæ Deleting workout from Firebase path:', docPath);
                console.log('üíæ Remaining exercises array:', currentPlan.exercises);
                
                await db.collection('clients').doc(currentClient.id).collection('plans').doc(currentPlan.id).update({
                    exercises: currentPlan.exercises
                });
                
                // Update UI
                document.getElementById('workoutCount').textContent = currentPlan.exercises.length;
                loadWorkouts();
                
                console.log('‚úÖ Workout deleted');
                
            } catch (error) {
                console.error('‚ùå Error deleting workout:', error);
                alert('Failed to delete workout');
            }
        };

        window.goBack = function() {
            window.location.href = 'pt-dashboard.html';
        };

        // Rename functionality
        window.showRenameForm = function() {
            document.getElementById('renameForm').style.display = 'block';
            document.getElementById('newPlanName').value = currentPlan.name || '';
            document.getElementById('newPlanName').focus();
        };

        window.cancelRenameForm = function() {
            document.getElementById('renameForm').style.display = 'none';
            document.getElementById('newPlanName').value = '';
        };

        window.savePlanName = async function() {
            const newName = document.getElementById('newPlanName').value.trim();
            
            if (!newName) {
                alert('‚ùå Please enter a plan name');
                return;
            }
            
            try {
                // Update plan name in Firebase
                await db.collection('clients').doc(currentClient.id).collection('plans').doc(currentPlan.id).update({
                    name: newName
                });
                
                // Update local data
                currentPlan.name = newName;
                
                // Update UI
                document.getElementById('planTitle').textContent = newName;
                window.cancelRenameForm();
                
                console.log('‚úÖ Plan name updated:', newName);
                
            } catch (error) {
                console.error('‚ùå Error updating plan name:', error);
                alert('Failed to update plan name');
            }
        };

        // Debug functions
        window.debugAddWorkout = function() {
            alert('üß™ Debug: Add workout function test');
            console.log('üß™ Current client:', currentClient);
            console.log('üß™ Current plan:', currentPlan);
        };

        window.testFirebasePath = async function() {
            try {
                const docPath = `clients/${currentClient.id}/plans/${currentPlan.id}`;
                console.log('üî• Testing Firebase path:', docPath);
                
                const doc = await db.collection('clients').doc(currentClient.id).collection('plans').doc(currentPlan.id).get();
                
                if (doc.exists) {
                    console.log('‚úÖ Document exists:', doc.data());
                    alert('‚úÖ Firebase path is valid and document exists!');
                } else {
                    console.log('‚ùå Document does not exist');
                    alert('‚ùå Document does not exist at this path');
                }
            } catch (error) {
                console.error('‚ùå Firebase test error:', error);
                alert('‚ùå Firebase test failed: ' + error.message);
            }
        };

        window.debugDatabaseLoading = async function() {
            console.log('üìä === DATABASE DEBUG ANALYSIS ===');
            
            const urlParams = new URLSearchParams(window.location.search);
            const clientId = urlParams.get('clientId');
            const planId = urlParams.get('planId');
            
            console.log('üìä URL Parameters:');
            console.log('  - clientId:', clientId);
            console.log('  - planId:', planId);
            
            console.log('üìä Firebase Connection:');
            console.log('  - firebase available:', typeof firebase !== 'undefined');
            console.log('  - db available:', typeof db !== 'undefined');
            
            try {
                // Check client document
                const clientDoc = await db.collection('clients').doc(clientId).get();
                console.log('üìä Client Document:');
                console.log('  - exists:', clientDoc.exists);
                if (clientDoc.exists) {
                    console.log('  - data:', clientDoc.data());
                }
                
                // Check plans subcollection
                const plansSnapshot = await db.collection('clients').doc(clientId).collection('plans').get();
                console.log('üìä Plans Subcollection:');
                console.log('  - size:', plansSnapshot.size);
                console.log('  - docs:', plansSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() })));
                
                // Check specific plan document
                const planDoc = await db.collection('clients').doc(clientId).collection('plans').doc(planId).get();
                console.log('üìä Plan Document:');
                console.log('  - exists:', planDoc.exists);
                if (planDoc.exists) {
                    console.log('  - data:', planDoc.data());
                }
                
                console.log('üìä Current Variables:');
                console.log('  - currentClient:', currentClient);
                console.log('  - currentPlan:', currentPlan);
                
                alert('üìä Debug analysis complete! Check console for details.');
                
            } catch (error) {
                console.error('‚ùå Debug analysis error:', error);
                alert('‚ùå Debug analysis failed: ' + error.message);
            }
        };

        // Load workouts
        function loadWorkouts() {
            const workoutList = document.getElementById('workoutList');
            
            if (!currentPlan.exercises || currentPlan.exercises.length === 0) {
                workoutList.innerHTML = `
                    <div class="empty-state">
                        <h3>No workouts added yet</h3>
                        <p>Click "Add Workout" to start building this plan</p>
                    </div>
                `;
                return;
            }
            
            workoutList.innerHTML = currentPlan.exercises.map((workout, index) => `
                <div class="workout-item">
                    <div class="workout-header">
                        <div class="workout-name">${workout.name}</div>
                    </div>
                    <div class="workout-details">
                        <div class="detail-item">
                            <div class="detail-label">Sets</div>
                            <div class="detail-value">${workout.sets || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Reps</div>
                            <div class="detail-value">${workout.reps || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Duration</div>
                            <div class="detail-value">${workout.duration || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">${workout.status || 'assigned'}</div>
                        </div>
                    </div>
                    ${workout.description ? `
                        <div class="workout-notes">
                            <strong>Notes:</strong> ${workout.description}
                        </div>
                    ` : ''}
                    <div class="workout-actions">
                        <button onclick="editWorkout(${index})" class="btn-edit">Edit</button>
                        <button onclick="deleteWorkout(${index})" class="btn-delete">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Load plan from URL
        async function loadPlanFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const clientId = urlParams.get('clientId');
            const planId = urlParams.get('planId');
            
            console.log('üîç Loading plan with URL params:', { clientId, planId });
            
            if (!clientId || !planId) {
                alert('‚ùå Missing client ID or plan ID in URL');
                window.goBack();
                return;
            }
            
            try {
                // Load client data
                const clientDoc = await db.collection('clients').doc(clientId).get();
                if (!clientDoc.exists) {
                    throw new Error('Client not found');
                }
                currentClient = { id: clientDoc.id, ...clientDoc.data() };
                
                // Load plan data
                const planDoc = await db.collection('clients').doc(clientId).collection('plans').doc(planId).get();
                if (!planDoc.exists) {
                    throw new Error('Plan not found');
                }
                currentPlan = { id: planDoc.id, ...planDoc.data() };
                
                // Update UI
                document.getElementById('planTitle').textContent = currentPlan.name || 'Unnamed Plan';
                document.getElementById('clientInfo').textContent = `Client: ${currentClient.name || 'Unknown'}`;
                document.getElementById('planDate').textContent = `Date: ${currentPlan.date || 'Not set'}`;
                document.getElementById('planStatus').textContent = `Status: ${currentPlan.status || 'assigned'}`;
                document.getElementById('workoutCount').textContent = `Workouts: ${currentPlan.exercises ? currentPlan.exercises.length : 0}`;
                
                // Load workouts
                loadWorkouts();
                
                console.log('‚úÖ Plan loaded successfully:', currentPlan);
                
            } catch (error) {
                console.error('‚ùå Error loading plan:', error);
                alert(`Failed to load plan: ${error.message}`);
                window.goBack();
            }
        }

        // Initialize page
        window.addEventListener('load', () => {
            console.log('üèãÔ∏è Workout Plan page loaded');
            loadPlanFromURL();
        });
    </script>
</body>
</html>
